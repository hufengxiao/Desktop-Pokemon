# Desktop-Pokemon 项目规划文档

## 项目概述

**项目名称**：Desktop-Pokemon
**项目定位**：跨平台赛博桌宠应用
**技术栈**：Python 3.10+ + PySide6
**目标平台**：Windows / macOS / Linux
**GitHub**：[项目仓库地址]
**当前版本**：v0.1.0-MVP
**状态**：✅ MVP 完成，可运行

---

## 核心功能

一个悬浮在桌面最上层、背景透明的小怪兽，可以：
- 根据电脑状态产生反馈（CPU/内存占用、时间等）
- 响应用户交互（点击、拖拽、喂食）
- 播放多种状态动画（待机、行走、吃东西、睡觉等）

---

## 技术方案

### 框架选择：Python + PySide6

**优势**：
- 轻量化，资源占用低
- Qt 框架对透明窗口、无边框窗口支持完善
- 丰富的动画系统（QPropertyAnimation）
- 跨平台兼容性好
- Python 生态丰富，便于扩展（如 psutil 监控系统状态）

**核心技术点**：
- `Qt.WindowStaysOnTopHint` - 窗口置顶
- `Qt.FramelessWindowHint` - 无边框窗口
- `setAttribute(Qt.WA_TranslucentBackground)` - 背景透明
- `QLabel` + `QMovie` / `QPixmap` - 图像/动画显示
- `QPropertyAnimation` - 平滑动画过渡
- `mousePressEvent` / `mouseMoveEvent` - 交互处理

---

## 开发路线图

### 阶段一：MVP 核心功能（第 1-2 周）

**目标**：实现基础桌宠框架

#### 1.1 项目初始化
- [x] 创建项目目录结构
- [x] 配置 Python 虚拟环境
- [x] 安装依赖（PySide6、psutil、Pillow）
- [x] 创建 requirements.txt

#### 1.2 窗口系统
- [x] 创建透明无边框窗口
- [x] 实现窗口置顶功能
- [x] 窗口拖拽功能（鼠标左键拖动）
- [x] 窗口位置记忆（关闭后重启恢复位置）

#### 1.3 基础动画系统
- [x] 图像资源加载模块
- [x] 静态图像显示（单帧）
- [x] GIF 动画循环播放
- [x] 动画状态切换（待机 → 其他状态）
- [x] 自动 GIF 时长检测（2026-01-15 新增）

#### 1.4 简单交互
- [x] 左键点击交互（播放反馈动画）
- [x] 右键菜单（退出程序）
- [x] 鼠标点击检测改进（使用曼哈顿距离）

**交付标准**：
- [x] 窗口能正常悬浮在桌面，背景完全透明
- [x] 能循环播放待机动画
- [x] 点击小怪兽有反馈（完整播放动画）
- [x] 可以拖拽移动位置
- [x] 右键菜单可退出
- [x] 窗口位置自动保存和恢复

---

## MVP 完成情况

### ✅ 核心功能 100% 完成

| 功能 | 状态 | 说明 |
|------|------|------|
| 透明无边框窗口 | ✅ 完成 | Qt.FramelessWindowHint + WA_TranslucentBackground |
| 窗口置顶 | ✅ 完成 | Qt.WindowStaysOnTopHint |
| 动画系统 | ✅ 完成 | 支持 GIF 和 PNG 动画 |
| 待机循环 | ✅ 完成 | 连续播放待机动画 |
| 点击反馈 | ✅ 完成 | 自动检测动画时长，完整播放 |
| 拖拽移动 | ✅ 完成 | 左键拖拽窗口 |
| 位置保存 | ✅ 完成 | JSON 配置文件持久化 |
| 右键菜单 | ✅ 完成 | 快速退出 |
| 资源加载 | ✅ 完成 | 支持多种图像格式 |
| 配置管理 | ✅ 完成 | 灵活的配置系统 |

### 已修复的 Bug

1. **编码错误** (2026-01-15)
   - 问题：Windows pip 无法读取 UTF-8 中文注释
   - 修复：移除所有中文注释，改用英文

2. **动画播放错误** (2026-01-15)
   - 问题：QMovie 调用了不存在的方法
   - 修复：使用定时器控制动画时长

3. **点击检测失败** (2026-01-15)
   - 问题：浮点数精度导致点击不被检测
   - 修复：改用曼哈顿距离判断（< 5 像素）

4. **动画被提前截断** (2026-01-15)
   - 问题：硬编码 600ms，不匹配实际 GIF 时长
   - 修复：自动检测 GIF 帧数和延迟，计算实际时长

---

### 阶段二：状态系统与智能行为（第 3-4 周）

**目标**：让桌宠"活"起来

#### 2.1 状态机设计
- [ ] 定义状态枚举（IDLE、WALK、EAT、SLEEP、HAPPY、SAD）
- [ ] 实现状态转换逻辑
- [ ] 状态持续时间控制
- [ ] 随机行为触发

#### 2.2 动画资源扩展
- [ ] 支持多套动画资源
- [ ] 行走动画 + 移动逻辑（在屏幕边缘来回走动）
- [ ] 睡觉动画（低活跃度时触发）
- [ ] 吃东西动画

#### 2.3 系统状态监控
- [ ] 使用 psutil 监控 CPU/内存占用
- [ ] 高负载时显示"疲惫"状态
- [ ] 低负载时显示"无聊"状态
- [ ] 时间段判断（深夜催促睡觉）

#### 2.4 喂食系统
- [ ] 右键菜单添加"喂食"选项
- [ ] 点击喂食播放 EAT 动画
- [ ] 饱食度属性（影响行为频率）

**交付标准**：
- 小怪兽会自动在屏幕上走动
- 根据电脑状态改变行为（如 CPU 高时显得疲惫）
- 可以喂食并有反馈

---

### 阶段三：高级交互与个性化（第 5-6 周）

**目标**：增强用户粘性

#### 3.1 多宠物支持
- [ ] 允许同时运行多个桌宠实例
- [ ] 不同种类的小怪兽（皮卡丘、杰尼龟等）
- [ ] 切换皮肤功能

#### 3.2 语音/文字气泡
- [ ] 在小怪兽上方显示对话气泡
- [ ] 根据状态显示不同文字（"好累啊~", "肚子饿了"）
- [ ] 可选：TTS 语音播报

#### 3.3 配置系统
- [ ] GUI 设置面板（透明度、音量、行为频率）
- [ ] 开机自启动选项
- [ ] 资源包热加载

#### 3.4 数据持久化
- [ ] 保存小怪兽状态（等级、亲密度）
- [ ] 互动历史记录
- [ ] 成就系统（喂食 100 次解锁特殊动画）

**交付标准**：
- 支持切换不同角色
- 小怪兽会"说话"
- 设置可调节

---

### 阶段四：打包与发布（第 7 周）

#### 4.1 跨平台测试
- [ ] Windows 10/11 测试
- [ ] macOS 测试（M1/M2 芯片兼容性）
- [ ] Linux 主流发行版测试

#### 4.2 打包发布
- [ ] 使用 PyInstaller 打包为独立可执行文件
- [ ] 制作安装程序（Windows 使用 Inno Setup）
- [ ] 编写用户文档

#### 4.3 性能优化
- [ ] 内存占用优化（图像资源缓存策略）
- [ ] CPU 占用优化（动画帧率控制）
- [ ] 启动速度优化

---

## 项目目录结构（初始规划）

```
Desktop-Pokemon/
├── src/
│   ├── main.py                 # 入口文件
│   ├── config.py               # 配置管理
│   ├── models/
│   │   ├── pet.py              # 宠物模型（状态、属性）
│   │   └── state_machine.py   # 状态机
│   ├── ui/
│   │   ├── pet_window.py       # 主窗口
│   │   ├── settings_dialog.py # 设置界面
│   │   └── context_menu.py    # 右键菜单
│   ├── core/
│   │   ├── animation.py        # 动画管理
│   │   ├── resource_loader.py # 资源加载
│   │   └── system_monitor.py  # 系统监控
│   └── utils/
│       ├── logger.py           # 日志工具
│       └── position_saver.py  # 窗口位置保存
├── assets/
│   ├── sprites/
│   │   ├── pikachu/
│   │   │   ├── idle.gif
│   │   │   ├── walk.gif
│   │   │   └── eat.gif
│   │   └── squirtle/
│   │       └── ...
│   ├── sounds/                 # 音效（可选）
│   └── icons/                  # 应用图标
├── tests/                      # 单元测试
├── docs/                       # 文档
├── requirements.txt            # 依赖列表
├── README.md                   # 项目说明
└── spec.md                     # 本文档
```

---

## MVP 版本需求清单

### 必须实现（P0）
1. ✅ 窗口透明化 + 无边框 + 置顶
2. ✅ 基础动画循环（至少一个待机动画）
3. ✅ 点击交互（点击后播放反馈动画）
4. ✅ 窗口拖拽功能
5. ✅ 退出程序的方式（右键菜单）

### 建议实现（P1）
6. 窗口位置记忆
7. 动画资源切换（2-3 种状态）
8. 简单的行走移动

### 可选功能（P2）
9. 系统状态监控
10. 音效反馈

---

## 资源需求清单

### MVP 阶段需要准备

1. **待机动画**（必需）
   - 格式：GIF 或 PNG 序列帧
   - 尺寸建议：128x128 或 256x256 像素
   - 背景：透明（PNG/GIF with alpha channel）
   - 数量：至少 1 个

2. **点击反馈动画**（必需）
   - 格式：同上
   - 示例：小怪兽跳一下、眨眼、挥手等
   - 数量：1-2 个

3. **应用图标**（可选）
   - 格式：ICO（Windows）/ PNG（多平台）
   - 尺寸：256x256

### 后续阶段资源

4. 行走动画（阶段二）
5. 吃东西动画（阶段二）
6. 睡觉动画（阶段二）
7. 音效文件（可选，WAV/MP3 格式）

---

## 技术风险与应对

| 风险 | 影响 | 应对方案 |
|------|------|---------|
| macOS 窗口置顶权限问题 | 中 | 提供手动授权指引 |
| 动画资源过大导致内存占用高 | 中 | 使用图像压缩，限制 GIF 帧数 |
| 不同 DPI 屏幕显示模糊 | 低 | 提供高分辨率资源，使用 Qt 的 HighDPI 支持 |
| 打包后体积过大 | 低 | 使用 PyInstaller 排除无用模块 |

---

## 后续扩展方向

1. **AI 对话**：接入大模型 API，让桌宠能回答问题
2. **联网功能**：多人桌宠互动、在线皮肤商店
3. **游戏化**：小游戏、任务系统
4. **生产力工具**：番茄钟、提醒事项
5. **数据可视化**：展示电脑使用统计

---

## 开发约定

- **代码风格**：遵循 PEP 8
- **注释语言**：中文（便于理解）
- **Git 提交**：每个功能模块完成后提交
- **测试**：核心逻辑编写单元测试
- **文档**：每个版本发布时更新 CHANGELOG.md 和 spec.md

---

## 项目发布与部署

### GitHub 发布

项目已发布到 GitHub，支持以下方式获取：

```bash
# 克隆项目
git clone [项目 GitHub URL]

# 安装依赖
pip install -r requirements.txt

# 运行程序
python src/main.py
```

### 版本管理

- **v0.1.0-MVP** (2026-01-15)：初始可运行版本
  - 核心功能 100% 完成
  - 所有 MVP 交付标准达成
  - 4 个 Bug 修复完成
  - 自动 GIF 时长检测

### 文件清单

**核心文件**：
- `src/main.py` - 应用入口
- `src/config.py` - 配置管理
- `src/ui/pet_window.py` - 主窗口（核心逻辑）
- `src/core/resource_loader.py` - 资源加载

**资源文件**：
- `assets/sprites/pikachu/idle.gif` - 待机动画
- `assets/sprites/pikachu/click.gif` - 点击动画
- `assets/icons/app_icon.png` - 应用图标

**文档**：
- `README.md` - 项目说明和使用指南
- `spec.md` - 本文档（项目规划）
- `CHANGELOG.md` - 版本更新日志
- `BUGFIX.md` - Bug 修复日志
- `TEST_GUIDE.md` - 测试指南
- `QUICKSTART.md` - 快速开始
- `PROJECT_STATUS.md` - 项目状态

**配置文件**：
- `requirements.txt` - Python 依赖
- `.gitignore` - Git 忽略配置
- `generate_placeholder.py` - 占位符生成工具

---

## 参考资料

- [PySide6 官方文档](https://doc.qt.io/qtforpython-6/)
- [Qt 官方文档](https://doc.qt.io/qt-6/)
- [Pillow 文档](https://pillow.readthedocs.io/)
- [psutil 文档](https://psutil.readthedocs.io/)

---

## 许可证

本项目采用 MIT 许可证。详见 LICENSE 文件。

---

## 贡献指南

欢迎提交 Issue 和 Pull Request！

在贡献前请确保：
1. 代码符合 PEP 8 规范
2. 添加适当的注释和文档
3. 测试通过，不引入新 Bug
4. 更新 CHANGELOG.md 和相关文档

---

**文档版本**：v1.1
**最后更新**：2026-01-15
**项目状态**：✅ MVP 完成，持续开发中
